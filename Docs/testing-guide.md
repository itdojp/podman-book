# 📋 テスト・検証ツールガイド

このガイドでは、書籍コンテンツの品質保証のための自動テスト・検証ツールの使用方法について説明します。

## 🎯 概要

コンテンツの品質を保証するために、以下の検証項目を自動的にチェックします：

- **リンク切れチェック** - 内部・外部リンクの有効性
- **画像の存在確認** - 画像ファイルの参照チェック
- **マークダウン構文の検証** - Markdown記法の正確性
- **メタデータの検証** - 必須フィールドの存在確認
- **文章校正** - 日本語技術文書の校正ルール
- **コンテンツ構造チェック** - 文字数制限、禁止ワードなど

## 🚀 利用可能なコマンド

### 基本的な検証コマンド

```bash
# 全体的な検証実行
npm run test

# 個別の検証ツール
npm run lint          # Markdownlint
npm run spell         # スペルチェック（cspell）
npm run link-check    # リンクチェック
npm run textlint      # 日本語文書校正
npm run validate      # カスタム検証スクリプト
```

### レポート生成

```bash
# HTMLレポート生成
npm run test:report

# レポートファイルの場所
validation-reports/validation-report.html
validation-reports/validation-report.json
```

## 📋 検証項目詳細

### 1. リンクチェック

**対象:**
- 内部リンク（相対パス、絶対パス）
- 外部リンク（HTTP/HTTPS）
- メールリンク（mailto:）

**チェック内容:**
- リンク先ファイルの存在確認
- URL形式の妥当性
- メールアドレス形式の妥当性
- 空のリンクテキストの検出

**例:**
```markdown
✅ 正常: [GitHub](https://github.com/itdojp)
❌ エラー: [存在しないファイル](./nonexistent.md)
⚠️ 警告: [](https://example.com)  # 空のリンクテキスト
```

### 2. 画像参照の検証

**対象:**
- ローカル画像ファイル
- 相対パス・絶対パスの画像参照

**チェック内容:**
- 画像ファイルの存在確認
- alt属性の存在確認

**例:**
```markdown
✅ 正常: ![説明文](./images/sample.png)
❌ エラー: ![説明文](./images/nonexistent.png)
⚠️ 警告: ![](./images/sample.png)  # alt属性が空
```

### 3. メタデータ検証

**対象:**
- フロントマターの必須フィールド
- メタデータの形式

**デフォルト必須フィールド:**
- `title` - ページタイトル

**例:**
```yaml
---
title: "章のタイトル"  # 必須
author: "著者名"      # オプション
---
```

### 4. コンテンツ構造チェック

**制限事項:**
- タイトル最大長: 100文字
- セクション最大長: 10,000文字

**禁止ワード:**
- `TODO` - 本番環境では削除が必要
- `FIXME` - 修正が必要な箇所
- `XXX` - 注意が必要な箇所

### 5. 文章校正（textlint）

**対象:**
- 日本語技術文書の校正ルール
- 句読点の統一
- 重複表現の検出

## ⚙️ 設定のカスタマイズ

### 検証設定の変更

`scripts/validate-content.js` の `CONFIG` オブジェクトで設定を変更できます：

```javascript
const CONFIG = {
  // 必須メタデータフィールド
  requiredMetadata: ['title', 'author'],
  
  // 文字数制限
  limits: {
    titleMaxLength: 50,
    sectionMaxLength: 5000
  },
  
  // 禁止ワード
  forbiddenWords: [
    'TODO',
    'FIXME',
    'XXX',
    'ダミー'
  ]
};
```

### スペルチェック設定

`cspell.json` でスペルチェックの設定を変更：

```json
{
  "words": [
    "カスタムワード",
    "固有名詞"
  ],
  "ignorePaths": [
    "除外ディレクトリ/**"
  ]
}
```

### textlint設定

`.textlintrc` で日本語校正の設定を変更：

```json
{
  "rules": {
    "preset-ja-technical-writing": {
      "max-ten": {
        "max": 3  // 一文中の「、」の最大数
      }
    }
  }
}
```

## 🔄 CI/CDとの統合

GitHub Actionsワークフローが自動的に設定されており、以下のタイミングで検証が実行されます：

- `main`、`develop` ブランチへのプッシュ
- `main` ブランチへのプルリクエスト
- `src/` ディレクトリ内のファイル変更時

### ワークフロー詳細

1. **Markdown linting** - 構文チェック
2. **Spell checking** - スペルチェック
3. **Link checking** - リンクチェック（外部リンクエラーは許容）
4. **Content validation** - カスタム検証
5. **Report generation** - HTMLレポート生成
6. **Artifact upload** - レポートファイルの保存

### プルリクエストでの自動コメント

プルリクエストには検証結果の要約が自動的にコメントされます：

```
## 📋 コンテンツ検証レポート

**検証統計:**
- ✅ 検証ファイル数: 5
- 🔗 チェックしたリンク数: 10
- 🖼️ チェックした画像数: 3
- ❌ エラー: 0
- ⚠️ 警告: 2

**✅ すべての検証項目をパスしました！**
```

## 🛠️ トラブルシューティング

### よくある問題と解決方法

#### 1. リンクチェックが失敗する

**原因:** 外部リンクへのアクセスに失敗
**解決:** `.markdown-link-check.json` で除外設定を追加

```json
{
  "ignorePatterns": [
    {
      "pattern": "^https://private-site\\.com/"
    }
  ]
}
```

#### 2. スペルチェックで固有名詞がエラーになる

**原因:** カスタム辞書に単語が登録されていない
**解決:** `cspell.json` の `words` 配列に追加

#### 3. textlintが厳しすぎる

**原因:** デフォルトのルールが厳格
**解決:** `.textlintrc` でルールを緩和または無効化

```json
{
  "rules": {
    "preset-ja-technical-writing": {
      "ja-no-successive-word": false  # 連続する同じ助詞を許可
    }
  }
}
```

#### 4. 画像パスエラー

**原因:** 相対パスの解決に失敗
**解決:** 画像ファイルのパスを確認し、正しい相対パスに修正

## 📊 レポートの見方

### HTMLレポート

生成されるHTMLレポートには以下の情報が含まれます：

- **統計サマリー** - エラー・警告の件数、チェック項目数
- **エラー詳細** - ファイル名、行番号、エラー内容
- **修正提案** - 各エラーに対する具体的な修正方法

### JSONレポート

プログラムで処理しやすいJSON形式のレポートも生成されます：

```json
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "stats": {
    "filesChecked": 5,
    "linksChecked": 10,
    "imagesChecked": 3
  },
  "summary": {
    "errors": 0,
    "warnings": 2,
    "total": 2
  },
  "errors": [],
  "warnings": [...]
}
```

## 🎯 ベストプラクティス

### 1. 定期的な検証実行

```bash
# 執筆中の定期チェック
npm run validate

# 週次での詳細チェック
npm run test:report
```

### 2. 段階的な修正

1. **エラー** を最優先で修正
2. **警告** を確認・対応
3. **情報** を参考にして改善

### 3. 継続的改善

- 検証結果を元にコンテンツ品質を継続的に改善
- チーム内での品質基準の共有
- 新しい検証ルールの追加検討

---

この検証ツールを活用することで、高品質な書籍コンテンツの維持が可能になります。定期的な検証実行と結果に基づく改善を心がけましょう。