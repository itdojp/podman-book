<svg width="900" height="650" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font: 700 18px Inter, sans-serif; fill: var(--color-text-primary, #1a202c); }
      .section-title { font: 600 14px Inter, sans-serif; fill: var(--color-text-primary, #1a202c); }
      .layer-text { font: 500 12px Inter, sans-serif; fill: var(--color-text-primary, #1a202c); }
      .component-text { font: 400 11px Inter, sans-serif; fill: var(--color-text-secondary, #4a5568); }
      .small-text { font: 400 10px Inter, sans-serif; fill: var(--color-text-secondary, #4a5568); }
      .mapping-text { font: 400 11px monospace; fill: var(--color-text-primary, #1a202c); }
      
      .host-space { fill: var(--color-blue-50, #ebf8ff); stroke: var(--color-blue-200, #90cdf4); }
      .user-ns { fill: var(--color-green-50, #f0fff4); stroke: var(--color-green-200, #68d391); }
      .container-ns { fill: var(--color-purple-50, #faf5ff); stroke: var(--color-purple-200, #c084fc); }
      .mapping { fill: var(--color-orange-50, #fffaf0); stroke: var(--color-orange-200, #fbb962); }
      .config { fill: var(--color-yellow-50, #fffff0); stroke: var(--color-yellow-200, #f6e05e); }
      .process { fill: var(--color-red-50, #fef5e7); stroke: var(--color-red-200, #fc8181); }
      .arrow { stroke: var(--color-gray-600, #718096); fill: var(--color-gray-600, #718096); }
      .mapping-arrow { stroke: var(--color-blue-500, #3182ce); fill: var(--color-blue-500, #3182ce); stroke-width: 2; }
    </style>
  </defs>

  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" class="title">Rootless Podman UID/GID マッピング図</text>

  <!-- Host System -->
  <g id="host-system">
    <rect x="50" y="60" width="250" height="480" class="host-space" />
    <text x="175" y="85" text-anchor="middle" class="section-title">Host System</text>
    
    <!-- Host Users -->
    <rect x="70" y="100" width="210" height="120" class="host-space" />
    <text x="175" y="120" text-anchor="middle" class="layer-text">Host UID/GID Space</text>
    
    <rect x="80" y="130" width="80" height="25" class="process" />
    <text x="120" y="147" text-anchor="middle" class="mapping-text">root (0:0)</text>
    
    <rect x="170" y="130" width="100" height="25" class="process" />
    <text x="220" y="147" text-anchor="middle" class="mapping-text">user1 (1000:1000)</text>
    
    <rect x="80" y="165" width="100" height="25" class="process" />
    <text x="130" y="182" text-anchor="middle" class="mapping-text">user2 (1001:1001)</text>
    
    <rect x="190" y="165" width="80" height="25" class="process" />
    <text x="230" y="182" text-anchor="middle" class="mapping-text">...(other)</text>
    
    <rect x="80" y="195" width="190" height="20" class="config" />
    <text x="175" y="209" text-anchor="middle" class="small-text">Sub-UID/GID Range: 165536:65536</text>
    
    <!-- Configuration Files -->
    <rect x="70" y="240" width="210" height="90" class="config" />
    <text x="175" y="260" text-anchor="middle" class="layer-text">Configuration Files</text>
    
    <rect x="80" y="270" width="90" height="25" class="config" />
    <text x="125" y="287" text-anchor="middle" class="component-text">/etc/subuid</text>
    
    <rect x="180" y="270" width="90" height="25" class="config" />
    <text x="225" y="287" text-anchor="middle" class="component-text">/etc/subgid</text>
    
    <rect x="80" y="305" width="190" height="20" class="config" />
    <text x="175" y="319" text-anchor="middle" class="mapping-text">user1:165536:65536</text>
    
    <!-- Kernel Support -->
    <rect x="70" y="350" width="210" height="60" class="host-space" />
    <text x="175" y="370" text-anchor="middle" class="layer-text">Kernel Support</text>
    <text x="175" y="385" text-anchor="middle" class="small-text">User Namespaces</text>
    <text x="175" y="400" text-anchor="middle" class="small-text">UID/GID Mapping</text>
    
    <!-- System Resources -->
    <rect x="70" y="430" width="210" height="90" class="host-space" />
    <text x="175" y="450" text-anchor="middle" class="layer-text">System Resources</text>
    <text x="175" y="470" text-anchor="middle" class="small-text">Files: real UID ownership</text>
    <text x="175" y="485" text-anchor="middle" class="small-text">Processes: mapped UID</text>
    <text x="175" y="500" text-anchor="middle" class="small-text">Network: unprivileged</text>
  </g>

  <!-- User Namespace -->
  <g id="user-namespace">
    <rect x="350" y="60" width="200" height="200" class="user-ns" />
    <text x="450" y="85" text-anchor="middle" class="section-title">User Namespace</text>
    <text x="450" y="105" text-anchor="middle" class="component-text">(user1の名前空間)</text>
    
    <!-- Mapping Table -->
    <rect x="370" y="120" width="160" height="120" class="mapping" />
    <text x="450" y="140" text-anchor="middle" class="layer-text">UID/GID Mapping</text>
    
    <!-- Mapping entries -->
    <rect x="380" y="150" width="70" height="20" class="mapping" />
    <text x="415" y="165" text-anchor="middle" class="small-text">Inside NS</text>
    
    <rect x="450" y="150" width="70" height="20" class="mapping" />
    <text x="485" y="165" text-anchor="middle" class="small-text">Host UID</text>
    
    <rect x="380" y="175" width="70" height="20" class="mapping" />
    <text x="415" y="190" text-anchor="middle" class="mapping-text">0</text>
    
    <rect x="450" y="175" width="70" height="20" class="mapping" />
    <text x="485" y="190" text-anchor="middle" class="mapping-text">1000</text>
    
    <rect x="380" y="200" width="70" height="20" class="mapping" />
    <text x="415" y="215" text-anchor="middle" class="mapping-text">1</text>
    
    <rect x="450" y="200" width="70" height="20" class="mapping" />
    <text x="485" y="215" text-anchor="middle" class="mapping-text">165536</text>
    
    <rect x="380" y="225" width="140" height="15" class="mapping" />
    <text x="450" y="237" text-anchor="middle" class="small-text">... (65536 mappings)</text>
  </g>

  <!-- Container Namespace -->
  <g id="container-namespace">
    <rect x="600" y="60" width="250" height="480" class="container-ns" />
    <text x="725" y="85" text-anchor="middle" class="section-title">Container Namespace</text>
    
    <!-- Container Processes -->
    <rect x="620" y="100" width="210" height="120" class="container-ns" />
    <text x="725" y="120" text-anchor="middle" class="layer-text">Container Processes</text>
    
    <rect x="630" y="130" width="80" height="25" class="process" />
    <text x="670" y="147" text-anchor="middle" class="mapping-text">root (0:0)</text>
    
    <rect x="720" y="130" width="100" height="25" class="process" />
    <text x="770" y="147" text-anchor="middle" class="mapping-text">app (1000:1000)</text>
    
    <rect x="630" y="165" width="100" height="25" class="process" />
    <text x="680" y="182" text-anchor="middle" class="mapping-text">nginx (33:33)</text>
    
    <rect x="740" y="165" width="80" height="25" class="process" />
    <text x="780" y="182" text-anchor="middle" class="mapping-text">...(other)</text>
    
    <rect x="630" y="195" width="190" height="20" class="container-ns" />
    <text x="725" y="209" text-anchor="middle" class="small-text">Container内では通常のUID/GID</text>
    
    <!-- File System View -->
    <rect x="620" y="240" width="210" height="90" class="container-ns" />
    <text x="725" y="260" text-anchor="middle" class="layer-text">File System View</text>
    
    <rect x="630" y="275" width="190" height="20" class="container-ns" />
    <text x="725" y="289" text-anchor="middle" class="small-text">/etc/passwd: root:x:0:0</text>
    
    <rect x="630" y="300" width="190" height="20" class="container-ns" />
    <text x="725" y="314" text-anchor="middle" class="small-text">/home/app: owner 1000:1000</text>
    
    <!-- Capabilities -->
    <rect x="620" y="350" width="210" height="80" class="container-ns" />
    <text x="725" y="370" text-anchor="middle" class="layer-text">Security Context</text>
    <text x="725" y="390" text-anchor="middle" class="small-text">rootコンテナでも実際は</text>
    <text x="725" y="405" text-anchor="middle" class="small-text">host上では非特権ユーザー</text>
    <text x="725" y="420" text-anchor="middle" class="small-text">真のroot権限なし</text>
    
    <!-- Container Benefits -->
    <rect x="620" y="450" width="210" height="70" class="container-ns" />
    <text x="725" y="470" text-anchor="middle" class="layer-text">セキュリティ利点</text>
    <text x="725" y="490" text-anchor="middle" class="small-text">• ホスト侵害防止</text>
    <text x="725" y="505" text-anchor="middle" class="small-text">• ファイル権限保護</text>
  </g>

  <!-- Mapping Process -->
  <g id="mapping-process">
    <text x="450" y="300" text-anchor="middle" class="section-title">マッピング処理の流れ</text>
    
    <!-- Step boxes -->
    <rect x="100" y="320" width="150" height="40" class="process" />
    <text x="175" y="335" text-anchor="middle" class="component-text">1. User Namespace作成</text>
    <text x="175" y="350" text-anchor="middle" class="small-text">unshare(CLONE_NEWUSER)</text>
    
    <rect x="270" y="320" width="150" height="40" class="process" />
    <text x="345" y="335" text-anchor="middle" class="component-text">2. UID/GIDマッピング</text>
    <text x="345" y="350" text-anchor="middle" class="small-text">/proc/self/uid_map書き込み</text>
    
    <rect x="440" y="320" width="150" height="40" class="process" />
    <text x="515" y="335" text-anchor="middle" class="component-text">3. コンテナプロセス起動</text>
    <text x="515" y="350" text-anchor="middle" class="small-text">mapped UID/GIDで実行</text>
    
    <rect x="610" y="320" width="150" height="40" class="process" />
    <text x="685" y="335" text-anchor="middle" class="component-text">4. ファイルアクセス</text>
    <text x="685" y="350" text-anchor="middle" class="small-text">カーネルが自動変換</text>
  </g>

  <!-- Arrows -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" class="arrow" />
    </marker>
    <marker id="mapping-arrowhead" markerWidth="12" markerHeight="9" refX="12" refY="4.5" orient="auto">
      <polygon points="0 0, 12 4.5, 0 9" class="mapping-arrow" />
    </marker>
  </defs>

  <!-- Host to User NS mapping -->
  <line x1="300" y1="180" x2="350" y2="180" stroke-width="3" class="mapping-arrow" marker-end="url(#mapping-arrowhead)" />
  <text x="325" y="175" text-anchor="middle" class="small-text">Mapping</text>

  <!-- User NS to Container NS mapping -->
  <line x1="550" y1="180" x2="600" y2="180" stroke-width="3" class="mapping-arrow" marker-end="url(#mapping-arrowhead)" />
  <text x="575" y="175" text-anchor="middle" class="small-text">Apply</text>

  <!-- Process flow arrows -->
  <line x1="250" y1="340" x2="270" y2="340" stroke-width="2" class="arrow" marker-end="url(#arrowhead)" />
  <line x1="420" y1="340" x2="440" y2="340" stroke-width="2" class="arrow" marker-end="url(#arrowhead)" />
  <line x1="590" y1="340" x2="610" y2="340" stroke-width="2" class="arrow" marker-end="url(#arrowhead)" />

  <!-- Example at bottom -->
  <g id="example" transform="translate(50, 580)">
    <text x="0" y="0" class="section-title">実例:</text>
    <text x="0" y="20" class="small-text">Host上のユーザー1000がコンテナ内でroot(0)として動作 → 実際のファイル所有者は1000のまま</text>
    <text x="0" y="40" class="small-text">コンテナ内でUID=1作成 → Host上ではUID=165536として見える → セキュリティ分離完了</text>
  </g>
</svg>